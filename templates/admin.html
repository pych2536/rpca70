{% extends "layout.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="admin-container">
    <header class="admin-header">
        <h1>Admin Dashboard</h1>
        <a href="{{ url_for('logout') }}" class="btn btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </header>

    <section class="card stats-grid">
        <div class="stat-item"><h3>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p>{{ stats.total }}</p></div>
        <div class="stat-item"><h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h3><p>{{ stats.confirmed }}</p></div>
        <div class="stat-item"><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3><p>{{ stats.unconfirmed }}</p></div>
        <div class="stat-item"><h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h3><div class="progress-bar"><div class="progress" style="width: {{ stats.percentage }}%;"></div></div><p>{{ stats.percentage }}%</p></div>
    </section>

    <section class="card controls-section">
        <h2>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h2>
        <div class="controls-grid">
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="control-item">
                <label for="file">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏•‡∏±‡∏Å</label><small>‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                <div class="upload-area"><input type="file" name="file" id="file" required accept=".csv"><button type="submit" class="btn btn-primary">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button></div>
            </form>
            <div class="control-item"><label>Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label><small>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV</small><a href="{{ url_for('export_csv') }}" class="btn btn-secondary full-width">Export to CSV</a></div>
            <form action="{{ url_for('admin_settings') }}" method="post" class="control-item">
                <label>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</label><small>‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ</small>
                <div class="settings-toggles">
                    <label class="switch"><input type="checkbox" name="user_editing_enabled" {% if settings.user_editing_enabled %}checked{% endif %}><span class="slider"></span> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ User ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    <label class="switch"><input type="checkbox" name="directory_view_enabled" {% if settings.directory_view_enabled %}checked{% endif %}><span class="slider"></span> ‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏£‡∏∏‡πà‡∏ô</label>
                </div>
                <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </form>
        </div>
    </section>

    <section class="card data-table-section">
        <h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <div class="table-wrapper">
            <table id="admin-table">
                <thead>
                    <tr>
                        {% for col in columns %}
                            <th class="sortable" data-column-index="{{ loop.index0 }}">{{ col }}</th>
                        {% endfor %}
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in records %}
                    <tr class="{{ 'confirmed' if row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï'] == '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß' else 'unconfirmed' }}">
                        {% for col in columns %}
                        <td>{{ row[col] }}</td>
                        {% endfor %}
                        <td class="action-links">
                             <a href="{{ url_for('edit_form', user_id=row['‡∏•‡∏≥‡∏î‡∏±‡∏ö']) }}" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‚úèÔ∏è</a>
                             <a href="{{ url_for('reset_status', user_id=row['‡∏•‡∏≥‡∏î‡∏±‡∏ö']) }}" onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">üîÑ</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="{{ columns|length + 1 }}" class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
// Simple table sorting script
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('admin-table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const columnIndex = parseInt(header.dataset.columnIndex, 10);
            const sortDirection = header.classList.contains('sorted-asc') ? 'desc' : 'asc';

            // Remove sorting classes from all headers
            headers.forEach(h => {
                h.classList.remove('sorted-asc', 'sorted-desc');
            });

            // Add sorting class to the clicked header
            header.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

            // Sort rows
            rows.sort((a, b) => {
                const aText = a.children[columnIndex].textContent.trim();
                const bText = b.children[columnIndex].textContent.trim();
                
                // Try to convert to number for numeric sorting
                const aVal = isNaN(parseFloat(aText)) ? aText : parseFloat(aText);
                const bVal = isNaN(parseFloat(bText)) ? bText : parseFloat(bText);

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows to the table body
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}